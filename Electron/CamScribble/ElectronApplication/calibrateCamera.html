<!DOCTYPE html>
<html>
<head>
  
  <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
  <style>

    #canvas-container {
      position:relative;
    }

    #canvas-container * {
      position:absolute;
      top:0px;
      left:0px;
    }

  </style>
</head>
<body>
  <div class="container container-main">
    <div id='canvas-container'>
      <canvas id="canvas"></canvas>
      <svg id="dragabbles" ></svg>
    </div>

    
    <canvas id="canvas-output"></canvas>

    <p>Position the colored dots at the corners of the drawing surface in the picture.</p>
  </div>

  <!-- Insert this line above script imports  -->
  <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
  <script src="js/jquery.min.js"></script>
  <script src="js/d3.js"></script>
  <script>if (window.module) module = window.module;</script>
  

  <script>

    function setDraggables(points,width,height,callback) {
      // set width and height for svg container
      var svgContainer = document.getElementById('dragabbles');
      svgContainer.setAttribute("width", width+"px");
      svgContainer.setAttribute("height", height+"px");

      var svg = d3.select("svg"),
        radius = 10,
        strokeWidth = 5;

      

      var circles = [
      {x: points[0][0] * width, y: points[0][1] * height, color: '#ff0000', name: 0, stroke: 'black'},
      {x: points[1][0] * width, y: points[1][1] * height, color: '#00ff00', name: 1, stroke: 'black'},
      {x: points[2][0] * width, y: points[2][1] * height, color: '#0000ff', name: 2, stroke: 'black'},
      {x: points[3][0] * width, y: points[3][1] * height, color: '#ffff00', name: 3, stroke: 'black'}
      ];

      

      var elem = svg.selectAll("circle")
        .data(circles)
        .enter().append("circle")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", radius)
          .attr("stroke", function(d) { return d.stroke; })
          .attr("stroke-width", strokeWidth)
          .style("fill", function(d, i) { return d.color; })
          .call(d3.drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended))
          .append("text")
            .attr("dx", function(d){return -20})
            .text(function(d){return d.name});

      function dragstarted(d) {
        d3.select(this).raise().classed("active", true);
      }

      function dragged(d) {
        if( d3.event.x >=0 && 
            d3.event.y >= 0 && 
            d3.event.x <= width && 
            d3.event.y <= height) {
          d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
        }
      }

      function dragended(d) {
        //d3.select(this).classed("active", false);

        callback(d.name,d.x/width,d.y/height);
        //console.log(d.name+': '+d.x/width+','+d.y/height);
      }
    }

  </script>
  

  <script>

  $(document).ready(function() {
    const GlCanvasForDummies = require('./js/GlCanvasForDummies');
    const CamScribble = require('cam_scribble').CamScribble;
    const {ipcRenderer} = require('electron');

    // setup openCV camera, and read the first image.
    var camScribble = new CamScribble([800,800],[0,0,0]);
    camScribble.setCamera(0);

    // width and height of the preview is 200x200
    camScribble.setHeight(0.5);
    camScribble.setWidth(0.5);

    var image = camScribble.getCameraFrame();
    var buf = image.toBuffer();
    var outputImage = camScribble.getFrame();
    var outputBuffer = outputImage.toBuffer();

    // Initialize glCanvas.
    var glCan = 
      new GlCanvasForDummies(
        document.getElementById('canvas'),
        image.width(),
        image.height());
    var glCanOutput = 
      new GlCanvasForDummies(
        document.getElementById('canvas-output'),
        200,
        200);


    var perspectivePoints =
    [
      [0.25,0.25],
      [0.75,0.25],
      [0.25,0.75],
      [0.75,0.75]
    ];
    // setup the draggables for the UI.
    setDraggables(perspectivePoints,image.width(),image.height(),function(name,x,y) {

      console.log(name);
      console.log(x + " " + y);

      perspectivePoints[name][0] = x;
      perspectivePoints[name][1] = y;

      camScribble.setPerspective(perspectivePoints);
    });

    document.getElementById('canvas-container').setAttribute("style","width:"+image.width()+"px");
    document.getElementById('canvas-container').setAttribute("style","height:"+image.height()+"px");

    // Enter the rendering loop.
    function renderLoop() {
      image = camScribble.getCameraFrame(image);
      buf = image.toBuffer(buf);


      outputImage = camScribble.getFrame(outputImage);
      outputBuffer = outputImage.toBuffer(outputBuffer);


      glCan.renderImage(buf,image.width(),image.height());
      glCanOutput.renderImage(outputBuffer,200,200);

      // Call renderLoop again after 1/15th of a second
      setTimeout(
        function() {
          requestAnimationFrame(renderLoop)
        },1000/15);
    }

    ipcRenderer.send('a-message','hahah');
    renderLoop();
  });
    

  </script>
</body>
</html>
